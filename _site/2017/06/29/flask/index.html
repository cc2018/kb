<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>flask源码 - Just for recording</title>

	<link rel="shortcut icon" href="/static/images/favicon.jpg">
	<link rel="icon" href="/static/images/favicon.jpg">

	<link rel="stylesheet" href="/static/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<link rel="canonical" href="/2017/06/29/flask/">
	<link rel="alternate" type="application/rss+xml" title="Just for recording" href="/feed.xml">

	<meta name="keywords" content="flask源码, Just for recording, personal blog;">
	<meta name="description" content="personal blog;">

	<script src="/static/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?ff1da0dd6c6a814ef6ec49dd10246092";
		  var s = document.getElementsByTagName("script")[0];
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
</head>


  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <span>CC-2018</span>
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">Categories</a>
        </li>
        <li>
          <a href="/tag">Tag</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

    <div class="docs-header" id="content">
  <div class="container">
      <div class="desc">
          
        		<!--
      		    <h1>flask源码</h1>
      		    <p>Post on Jun 29, 2017 by <a href="/about">CC-2018</a></p>
      		-->
      		    <h1>Some words wanna say</h1>
          
      </div>
  </div>
</div>

    
      
<div class="docs-banner">
  <div class="container">
      <div class="row">
          
          	<a href="/categories/#document-ref">document</a>	/
          	<a href="/tag/#总结-ref">总结</a>
          
      </div>

  </div>
</div>

    

    <div class="docs-container container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h2>目录</h2>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_August">August</a></li>
      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
              <li><a href="#month_2017_July">July</a></li>
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
              <li><a href="#month_2017_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div>

      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">flask源码</h1>
              <!--
                <p class="post-meta">Jun 29, 2017 • CC-2018</p>
              -->
              <div class="meta">Posted on <span class="postdate">Jun 29, 2017</span> By <a target="_blank" href="http://localhost:4000">CC-2018</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#wsgi" id="markdown-toc-wsgi">wsgi</a></li>
  <li><a href="#werkzeug-local" id="markdown-toc-werkzeug-local">werkzeug local</a></li>
  <li><a href="#pytest" id="markdown-toc-pytest">pytest</a></li>
  <li><a href="#config" id="markdown-toc-config">config</a></li>
  <li><a href="#globals" id="markdown-toc-globals">globals</a></li>
  <li><a href="#_compat" id="markdown-toc-_compat">_compat</a></li>
  <li><a href="#signals" id="markdown-toc-signals">signals</a></li>
  <li><a href="#wrappers" id="markdown-toc-wrappers">wrappers</a></li>
  <li><a href="#sessions" id="markdown-toc-sessions">sessions</a></li>
  <li><a href="#templating" id="markdown-toc-templating">templating</a></li>
</ul>

<ol>
  <li>config原理，其他模块调用config的地方</li>
  <li>路由原理</li>
  <li>Wsgi接口调用</li>
  <li>理解session</li>
  <li>理解threading.local</li>
  <li>理解flask自己封装的thread local</li>
  <li>理解g和request</li>
  <li>理解app context和request context</li>
</ol>

<h3 id="wsgi">wsgi</h3>

<p>WSGI接口定义非常简单，它只要求Web开发者实现一个函数，就可以响应HTTP请求。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def application(environ, start_response):
    start_response('200 OK', [('Content-Type', 'text/html')])
    return '&lt;h1&gt;Hello, web!&lt;/h1&gt;'
</code></pre>
</div>
<p>上面的application()函数就是符合WSGI标准的一个HTTP处理函数，它接收两个参数：
environ：一个包含所有HTTP请求信息的dict对象；
start_response：一个发送HTTP响应的函数。</p>

<p>再启动WSGI服务器，去加载application，整个最简单的web应用就建立起来了</p>

<h3 id="werkzeug-local">werkzeug local</h3>

<p><strong>local</strong></p>

<p>Local 是个线程局部对象，里面有个<code class="highlighter-rouge">__storage__</code>: <code class="highlighter-rouge">storage[ident][name] = value</code>, ident为线程或协程id</p>

<p>实现<code class="highlighter-rouge">__getattr__</code>, <code class="highlighter-rouge">__setattr__</code>, <code class="highlighter-rouge">__delattr__</code>, 好让dict里的k-v能通过’.’调用</p>

<p>实现<code class="highlighter-rouge">__call__</code>，通过类似函数调用生成LocalProxy代理</p>

<p><strong>LocalStack</strong></p>

<p>封装了<code class="highlighter-rouge">local</code>，不过local内只有一个叫<code class="highlighter-rouge">stack</code>的k-v，其value是list，所以能实现push，pop，top</p>

<p>而pop到最后一个元素时，会把local dict里面的stack对象给pop掉，等push时重新创建</p>

<p>flask 里面的这个list存放的是object，object又有一些属性数据</p>

<div class="highlighter-rouge"><pre class="highlight"><code>_request_ctx_stack = LocalStack()
_app_ctx_stack = LocalStack()
</code></pre>
</div>

<h3 id="pytest">pytest</h3>

<p>http://blog.csdn.net/wwq_1111/article/details/51242011</p>

<h3 id="config">config</h3>

<p>config模块本质上是一个dict，存储一些k-v，支持多种加载模式：</p>

<ol>
  <li>
    <p>从py文件加载，用types创建一个临时模块config，解析py字节流，将全局变量存储到config模块的__dict__里。<br />
<code class="highlighter-rouge">exec(compile(config_file.read(), filename, 'exec'), d.__dict__)</code>。compile编译序列语句，exec，执行，将结果保存到dict里面</p>
  </li>
  <li>
    <p>从模块加载：用dir获取模块的属性，如果是大写的就存储到dict里面</p>
  </li>
  <li>
    <p>from_object，也可以提供模块名称，这样会先import模块，再解析模块属性</p>
  </li>
</ol>

<h3 id="globals">globals</h3>

<p>保存了两个线程局部变量<code class="highlighter-rouge">_request_ctx_stack</code>, <code class="highlighter-rouge">_app_ctx_stack</code>, 前者保存了request, session信息，后者保存了app，g信息。
为什么<code class="highlighter-rouge">_request_ctx_stack.top</code>，就是当前的活跃request？</p>

<h3 id="_compat">_compat</h3>

<p>py2/py3 版本兼容，定义了text_type，string_types，integer_types，iterkeys，itervalues，iteritems，reraise，BROKEN_PYPY_CTXMGR_EXIT</p>

<h3 id="signals">signals</h3>

<p>flask的signals 基于blinker实现信号的发送和订阅</p>

<p><strong>创建信号</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>_signals = Namespace()
template_rendered = _signals.signal('template-rendered')
</code></pre>
</div>

<p>通过signal()，以名字为参数创建信号</p>

<p><strong>订阅信号</strong></p>

<p>使用Signal.connect()方法注册一个回调函数（即订阅者），处理触发的信号，该函数以触发信号的对象作为参数。</p>

<p><strong>触发信号</strong></p>

<p>使用Signal.send()方法通知信号订阅者。</p>

<p><strong>flask 核心信号</strong></p>
<div class="highlighter-rouge"><pre class="highlight"><code>template_rendered = _signals.signal('template-rendered')
before_render_template = _signals.signal('before-render-template')
request_started = _signals.signal('request-started')
request_finished = _signals.signal('request-finished')
request_tearing_down = _signals.signal('request-tearing-down')
got_request_exception = _signals.signal('got-request-exception')
appcontext_tearing_down = _signals.signal('appcontext-tearing-down')
appcontext_pushed = _signals.signal('appcontext-pushed')
appcontext_popped = _signals.signal('appcontext-popped')
message_flashed = _signals.signal('message-flashed')
</code></pre>
</div>

<h3 id="wrappers">wrappers</h3>

<p>封装了werkzeug.wrappers的Request和Response，做了个mimetype为json的数据解析</p>

<p>request和response，包含了请求和回应的 header和body，以及url解析内容</p>

<p>url参数可使用常见参数：</p>

<p>假设用户请求为<code class="highlighter-rouge">http://www.example.com/myapplication/page.html?x=y</code></p>

<p>则解析如下：</p>
<div class="highlighter-rouge"><pre class="highlight"><code>path        /page.html
script_root /myapplication
base_url    http://www.example.com/myapplication/page.html
url         http://www.example.com/myapplication/page.html?x=y
url_root    http://www.example.com/myapplication/
</code></pre>
</div>

<p>数据内容可使用常见参数：
form args values cookies headers data files method 等。</p>

<h3 id="sessions">sessions</h3>

<p>用户会话，用于存储请求之间需要记住的键值对</p>

<p>处理登录，token处理，和跨站攻击</p>

<p>http://blog.csdn.net/hyman_c/article/details/54023685</p>

<p>http://www.tuicool.com/articles/M3Q3ui</p>

<p>http://www.jianshu.com/p/46fd7e66b7d5</p>

<p>http://itsdangerous.readthedocs.io/en/latest/</p>

<p>http://docs.jinkan.org/docs/flask/testing.html#testing</p>

<h3 id="templating">templating</h3>

            </article>
        </div>
      </div>
      <!-- <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
            <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
          </div>
        </article>
      </div> -->
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2016-2017 CC-2018.</p>
	</div>
</footer>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/holder.min.js"></script>
<script src="/static/js/lessismore.js"></script>
<script src="/static/js/application.js"></script>


  </body>
</html>
