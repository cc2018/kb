<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>flask源码分析：启动流程 - Just for recording</title>

	<link rel="shortcut icon" href="/static/images/favicon.jpg">
	<link rel="icon" href="/static/images/favicon.jpg">

	<link rel="stylesheet" href="/static/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<link rel="canonical" href="/2017/07/31/flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">
	<link rel="alternate" type="application/rss+xml" title="Just for recording" href="/feed.xml">

	<meta name="keywords" content="flask源码分析：启动流程, Just for recording, personal blog;">
	<meta name="description" content="personal blog;">

	<script src="/static/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?ff1da0dd6c6a814ef6ec49dd10246092";
		  var s = document.getElementsByTagName("script")[0];
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
</head>


  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <span>CC-2018</span>
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">Categories</a>
        </li>
        <li>
          <a href="/tag">Tag</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

    <div class="docs-header" id="content">
  <div class="container">
      <div class="desc">
          
        		<!--
      		    <h1>flask源码分析：启动流程</h1>
      		    <p>Post on Jul 31, 2017 by <a href="/about">CC-2018</a></p>
      		-->
      		    <h1>Some words wanna say</h1>
          
      </div>
  </div>
</div>

    
      
<div class="docs-banner">
  <div class="container">
      <div class="row">
          
          	<a href="/categories/#reading-ref">reading</a>	/
          	<a href="/tag/#总结-ref">总结</a>
          
      </div>

  </div>
</div>

    

    <div class="docs-container container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h2>目录</h2>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_August">August</a></li>
      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
              <li><a href="#month_2017_July">July</a></li>
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
              <li><a href="#month_2017_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
        
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div>

      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">flask源码分析：启动流程</h1>
              <!--
                <p class="post-meta">Jul 31, 2017 • CC-2018</p>
              -->
              <div class="meta">Posted on <span class="postdate">Jul 31, 2017</span> By <a target="_blank" href="http://localhost:4000">CC-2018</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#启动流程" id="markdown-toc-启动流程">启动流程</a></li>
  <li><a href="#路由过程" id="markdown-toc-路由过程">路由过程</a></li>
</ul>

<p>要了解flask的启动流程，先要了解基本的wsgi协议：<a href="http://cizixs.com/2014/11/08/understand-wsgi">wsgi介绍</a></p>

<h3 id="启动流程">启动流程</h3>

<p>这里我们要弄清楚一个核心流程，当一个请求request过来时（信息都在environ里），中间经过那些处理流程，最后返回start_response的。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>from flask import Flask
app = Flask(__name__)

if __name__ == '__main__':
    app.run()
</code></pre>
</div>
<p>只需要以上几行代码就可以启动flask，先看<code class="highlighter-rouge">Flask.__init__()</code>和<code class="highlighter-rouge">Flask.run()</code>，做了什么：</p>

<p>Flask继承<code class="highlighter-rouge">_PackageBoundObject</code>, <code class="highlighter-rouge">_PackageBoundObject</code>处理以下逻辑：</p>

<ul>
  <li>根据传入的root_path，或者使用import_name获取root_path</li>
  <li>静态资源文件夹属性，static_url_path属性</li>
  <li>Jinja loader</li>
  <li>发送静态文件</li>
  <li>open_resource打开root_path下的资源文件</li>
</ul>

<p><code class="highlighter-rouge">Flask.__init__</code>的处理逻辑：</p>

<ul>
  <li>根据default_config创建config实例</li>
  <li>初始化很多属性：url_map，系列钩子函数dict或list，extensions等</li>
  <li>自动加上静态文件路由</li>
  <li>创建click.Group，实现相关命令行的功能（涉及到click）</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>if self.has_static_folder:
    assert bool(static_host) == host_matching, 'Invalid static_host/host_matching combination'
    self.add_url_rule(
        self.static_url_path + '/&lt;path:filename&gt;',
        endpoint='static',
        host=static_host,
        view_func=self.send_static_file
    )

#: The click command line context for this application.  Commands
#: registered here show up in the :command:`flask` command once the
#: application has been discovered.  The default commands are
#: provided by Flask itself and can be overridden.
#:
#: This is an instance of a :class:`click.Group` object.
self.cli = cli.AppGroup(self.name)
</code></pre>
</div>

<p>再看<code class="highlighter-rouge">Flask.run</code>: <code class="highlighter-rouge">Flask.run</code>除了设置可选的host，port参数外，只是调用了<code class="highlighter-rouge">werkzeug.serving.run_simple</code>，然后运行<code class="highlighter-rouge">BaseWSGIServer.serve_forever</code>，永久的监听请求，当有请求来时，会调用WSGIRequestHandler.execute里：</p>
<div class="highlighter-rouge"><pre class="highlight"><code>def execute(app):
    application_iter = app(environ, start_response)
    try:
        for data in application_iter:
            write(data)
        if not headers_sent:
            write(b'')
    finally:
        if hasattr(application_iter, 'close'):
            application_iter.close()
        application_iter = None
</code></pre>
</div>

<p>会调用实例app()，可参考<a href="http://cizixs.com/2014/11/08/understand-wsgi">wsgi协议介绍</a>，这里就和Flask的app实例结合起来了。因为Flask实现了<code class="highlighter-rouge">__call__</code>，支持对象调用：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def __call__(self, environ, start_response):
    """Shortcut for :attr:`wsgi_app`."""
    return self.wsgi_app(environ, start_response)

def wsgi_app(self, environ, start_response):
    ctx = self.request_context(environ)
    error = None
    try:
        try:
            ctx.push()
            # 这里由经路由处理函数后的结果，并由body结果生成Response对象
            response = self.full_dispatch_request()
        except Exception as e:
            error = e
            response = self.handle_exception(e)
        except:
            error = sys.exc_info()[1]
            raise
        return response(environ, start_response)
    finally:
        if self.should_ignore_error(error):
            error = None
        ctx.auto_pop(error)
</code></pre>
</div>

<p>去掉钩子函数处理，这里主要的一个request流程：</p>
<ul>
  <li>创建RequestContext(内生成Request)</li>
  <li>RequestContext压栈</li>
  <li>处理request得到response实例（Response处理header信息，并保存[body]）</li>
  <li>response的<code class="highlighter-rouge">__call__</code>里调用start_response返回状态码和header</li>
  <li>返回可迭代的对象（内包含body数据）</li>
  <li>RequestContext出栈</li>
</ul>

<h3 id="路由过程">路由过程</h3>

<p>注册路由</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Basically this example::

    @app.route('/')
    def index():
        pass

Is equivalent to the following::

    def index():
        pass
    app.add_url_rule('/', 'index', index)
</code></pre>
</div>

<p>主要调用add_url_rule()，add_url_rule根据函数名称生成endpint，分别将url-&gt;endpint的url存储到url_map，endpint-&gt;view_function存储到view_functions中</p>

<p>所以url_map和view_functions支持了整个路由的数据过程，当请求来时，由RequestContext实现匹配的过程。</p>

<p>RequestContext的代码去掉压栈和出栈过程，和请求处理相关的代码如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class RequestContext(object):
    def __init__(self, app, environ, request=None):
    self.app = app
    if request is None:
        request = app.request_class(environ)
    self.request = request
    self.url_adapter = app.create_url_adapter(self.request)
    self.flashes = None
    self.session = None

    self.match_request()

    def match_request(self):
        """Can be overridden by a subclass to hook into the matching
        of the request.
        """
        try:
            url_rule, self.request.view_args = \
                self.url_adapter.match(return_rule=True)
            self.request.url_rule = url_rule
        except HTTPException as e:
            self.request.routing_exception = e
</code></pre>
</div>
<ul>
  <li>RequestContext里面缓存的变量有app，session，request flashes，url_adapter，environ传递给request（两者互相绑定）</li>
  <li>将app的url_map绑定到Request.environ上，url_map为Map对象，包含了Rule（url-&gt;endpoint），再创建werkzeug.routing.MapAdapter对象</li>
  <li>调用MapAdapter.match方法进行匹配，得到Rule，即url-&gt;endpoint，并把Rule存储到Request里</li>
  <li>最后调用<code class="highlighter-rouge">self.view_functions[rule.endpoint](**req.view_args)</code>，用endpoint获取到对应的view_function处理</li>
</ul>

            </article>
        </div>
      </div>
      <!-- <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
            <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
          </div>
        </article>
      </div> -->
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2016-2017 CC-2018.</p>
	</div>
</footer>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/holder.min.js"></script>
<script src="/static/js/lessismore.js"></script>
<script src="/static/js/application.js"></script>


  </body>
</html>
